stages:
- build-and-push

variables:
  IMAGE_TAG: "546.0.1"

build-and-push:
  stage: build-and-push
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  image:
    name: moby/buildkit:rootless
    entrypoint: [""]
  before_script:
  - |
    mkdir -p $CI_PROJECT_DIR/bin
    export PATH=${CI_PROJECT_DIR}/bin:${PATH}
    wget -q -O credHelper.tar.gz https://github.com/GoogleCloudPlatform/docker-credential-gcr/releases/download/v2.1.29/docker-credential-gcr_linux_amd64-2.1.29.tar.gz
    tar -xzf credHelper.tar.gz
    chmod +x docker-credential-gcr
    mv docker-credential-gcr ${CI_PROJECT_DIR}/bin/
    docker-credential-gcr configure-docker --registries=europe-docker.pkg.dev
  script:
  - |
    echo "Building image [al3xos/ci-tools:${IMAGE_TAG}]"
    buildctl-daemonless.sh build \
      --frontend=dockerfile.v0 \
      --local context=${CI_PROJECT_DIR} \
      --local dockerfile=${CI_PROJECT_DIR} \
      --opt filename=Dockerfile \
      --output type=image,name=al3xos/ci-tools:${IMAGE_TAG},push=true \
      --output type=image,name=al3xos/ci-tools:latest,push=true
